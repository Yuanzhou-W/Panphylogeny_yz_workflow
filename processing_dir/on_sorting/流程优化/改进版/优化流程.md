![[20230811_工作总结/改进版/宏转录组/abundance_std_s01_corrected_final_use.py]]# 基因组检索收集 - 202306
1. 通过NCBI + GTDB的检索，收集了共1418株系的原绿球藻
2. 通过checkm，获得了基因组质量信息
```
conda activate metawrap
checkm lineage_wf /data/gj/221206/genome /data/gj/221206/checkm -x fasta -t 40 -f /data/gj/221206/checkm/result.txt --tab_table

```
# 去除有序列污染的基因组
## acdc
GitHub地址: [GitHub - mlux86/acdc:](https://github.com/mlux86/acdc)
```
acdc -I [path-to-fasta.list]
```
## 解决问题
1.  现状：
    - 丰度分析中有反常分布，系统发育树中有异常的拓扑关系，经过实际操作中发现，这些株系在acdc中是建议清除的 (eg. MIT9201)
    - checkm中的三个参数com、cont、SH在实际操作中均无法很好的去除该影响
    - dRep去冗余中，实际上只通过完整度和ANI聚类，也就是说带入有别株系污染的基因组，会将其他合格基因组的位置替换掉。
2. 解决方法
    - 在drep前运行acdc，直接去除有问题的株系基因组，同时记录

# 去除异质性(strain heterogeneity)<5的基因组
## checkm
[Github-Ecogenomics/CheckM](https://github.com/Ecogenomics/CheckM)
```
checkm lineage_wf -x fasta /home/dwj/workspace/Y61_12/SPA/new/spades/spades_output_default/filtered_contigs.fasta 61_12checkm
```
## checkm2
既然出新了，不用白不用
[GitHub - chklovski/CheckM2](https://github.com/chklovski/CheckM2)
```
checkm2 predict --threads 30 --input ../bin1.fa ../../bin2.fna /some/other/directory/bin3.fasta --output-directory <output_folder> 
```
## 解决问题
1. dRep不会对于异质性作去冗余，所以提前去除，以免经过ANI聚类后替换掉合格基因组
2. 异质性会导致回帖错误和进化树拓扑结构异常，所以尽量靠前处理

# 去除冗余基因组
## dRep
### 原理图
![[drep原理图.drawio]]
![[drep-流程.png]]
## 任务
1. 第一次：com90 - ANIm98 - cont5，取非sc部分
2. 第二次：com50 - ANIm98 - cont5，取sc部分
- 对单细胞测序基因组的完整度要求不要太高 >50
```
conda activate drep
dRep dereplicate /data/wlh/基因组数据_final/数据整理_Pro_Syn/drep_pro/ANImf/contam10/ANI95/dereplication359095/ -p 40 -g /data/wlh/基因组数据_final/数据整理_Pro_Syn/原绿球藻/data_newname/*.fasta --checkM_method lineage_wf --set_recursion 2000 --checkm_group_size 2000 --gen_warnings --warn_dist 0.25 --warn_sim 0.98 --warn_aln 0.25 -comp 35 -con 10 -pa 0.9 -sa 0.95 
```
# 规范格式
## anvio - 规范格式+去除短contig（<2000）
```
anvi-script-reformat-fasta [fasta]  -o [contigs-fasta]  -l 2000  --simplify-names
```
## 针对clade和基因组名称，重新起名
![[按照改名表批量提取并改文件名_II.py]]

![[20230811_工作总结/改进版/脚本/文件名修改contig名称.py]]

![[文件名修改contig名称_II.py]]

## 合并基因组
```
cat *.fasta > all_2kb.fasta
```
## 注意：
1. contig改名是因为泛基因组以及回贴中，有一些脚本(个性化操作)，需要在contig水平作划分，
2. 基因组改名是为了系统发育分析中，易于通过clade名称，确认系统发育树的结构。同时泛基因组中也需要该因素
3. 合并基因组是为了后续回贴和方便注释需要

# 确定直系同源基因
## 注释
```
cat *.fasta > all_proteins.fasta

conda activate eggnog_wlh
mkdir /lomi_home/wangluhang/SUSTech_project/task/orthofinder/AA_genome_contigname_clade_function/all_Pro_protein_eggnog
emapper.py --cpu 32 -o all_Pro_protein_eggnog --output_dir /lomi_home/wangluhang/SUSTech_project/task/orthofinder/AA_genome_contigname_clade_function/all_Pro_protein_eggnog --override -m diamond --dmnd_ignore_warnings  -i /lomi_home/wangluhang/SUSTech_project/task/orthofinder/AA_genome_contigname_clade_function/all_Pro_protein.fasta --evalue 0.001 --score 60 --pident 40 --query_cover 20 --subject_cover 20 --itype proteins --excel
```
## 加入蛋白质功能名称
contig再次改名，加入功能信息，便于分析
![[根据注释信息表_修改contig名称.py]]
## orthofinder
[GitHub - davidemms/OrthoFinder](https://github.com/davidemms/OrthoFinder)
```
orthofinder -t 32 -a 32 -M msa -A muscle -T iqtree  -f "/lomi_home/wangluhang/SUSTech_project/task/orthofinder/AA_genome_clade_genome/"
```

# 泛基因组 - anvio-pangenome workflow
## 常规
[[anvi-pangenome_workflow]]![[anvi-pangenome.sh]]
# 基于gene cluster和anvio-pangenome进行的系统发育分析
## add-系统发育学分析内容
[[基于anvio的cluster_进行的系统发育分析]]
包括导出需要的核心基因组部分cluster和单独进行的muscle、iqtree、trimAI建树部分

## cluster建树与gtdb建树之间的相似性（?）
### TreeCmp
[GitHub - TreeCmp/TreeCmp](https://github.com/TreeCmp/TreeCmp)
```
#需要newick格式的树文件
##iqtree输出的example.phy.treefile格式文件

#是与gtdb结果比较还是各基因簇之间比较？

java -jar bin/TreeCmp.jar -w 2 -d ms -i examples/beast/testBSP.newick -o testBSP.newick_w_2.out -I
```

# 宏转录组分析
## 基因组数据预处理
 ## 合并基因组
```
cat *.fasta > all_2kb.fasta
```

## 区域masking: 
### 识别mask区域
#### 识别rRNA
##### metaxa2
```
conda activate metaxa2
metaxa2 --plus --mode m --cpu 32 --multi_thread T --table T -g ssu --not_found T  -1 all_2kb.fasta -o all_2kb.metaxa2_ssu

metaxa2 --plus --mode m --cpu 32 --multi_thread T --table T -g lsu --not_found T  -1 all_2kb.fasta -o all_2kb.metaxa2_lsu

cut -f 1,9,10 all_2kb.metaxa2_ssu.extraction.results >> masked_metaxa.bed

cut -f 1,9,10 all_2kb.metaxa2_lsu.extraction.results >> masked_metaxa.bed
```
##### barrnap
```
conda activate barrnap_wlh
barrnap --kingdom bac --threads 32 --reject 0.3 all_2kb.fasta > out_bac.gff

barrnap --kingdom arc --threads 32 --reject 0.3 all_2kb.fasta > out_arc.gff

barrnap --kingdom euk --threads 32 --reject 0.3 all_2kb.fasta > out_euk.gff

cut -f 1,4,5 out_bac.gff >> masked_barrnap.bed
cut -f 1,4,5 out_arc.gff >> masked_barrnap.bed
cut -f 1,4,5 out_euk.gff >> masked_barrnap.bed

cat masked_barrnap.bed masked_metaxa.bed > masked_rrna.bed


```
#### 识别tRNA
##### tRNAscan-SE
```
conda activate tRNAscan-SE_wlh
tRNAscan-SE -A -b all_2kb.bedformat --thread 32 all_2kb.fasta

cut -f 1,2,3 all_2kb.bedformat >> masked_trna.bed
```
#### 识别低复杂度区域
##### ncbi-cxx-toolkit - dustmasker
```
module load ncbi-cxx-toolkit

dustmasker -in all_mags_2kb_clean.fasta -out all_mags_2k_decontaminated.lowcom.out -outfmt acclist

sed 's/>//' all_mags_2k_decontaminated.lowcom.out > masked_dustmasker.bed
```
### 对以上区域进行mask
##### bedtools
```
cat masked_rrna.bed masked_trna.bed masked_dustmasker.bed > all_mags_2k_masked.bed

conda activate bedtools 
bedtools maskfasta -fi all_mags_2kb_clean.fasta -bed all_mags_2k_masked.bed -fo all_mags_2k_masked.fa
```
## 解决问题
1. 不进行mask，这些高度相似的tRNA、rRNA等会在回贴造成错贴的现象。在丰度分析中表现为高coverge和低detection以及异常丰度分布，转录组高级分析中表现为一些莫名其妙的基因成为DEG
2. 这里注重于附属或者非中心法则基因组对于环境因素的响应分析，所以应该去除
3. 也可以和不去除做个对比
## Tara Ocean回贴
![[搜库-Counts+abundance.png]]

### 丰度分析
[[20230811_工作总结/改进版/宏转录组/anvio_metaT]]
[[20230811_工作总结/改进版/宏转录组/丰度矩阵工作流程]]
![[20230811_工作总结/改进版/宏转录组/abundance_std_s01_corrected_final_use.py]]
### 转录组高级分析
![[split_gtf_by_strain.py]]
[[20230811_工作总结/改进版/宏转录组/wlh_mapping]]
#### foldchange
#### WGCNA
